from escaperoom.transcript import Transcript
from escaperoom.rooms.base import GameState
from escaperoom.rooms.base import Room
from escaperoom.utils import read_jsonl
import os
import collections


class MalwareRoom(Room):
    def __init__(self, data_dir: str):
        super().__init__("Malware Lab", "Items here: proc_tree.jsonl")
        self.path = os.path.join(data_dir, "proc_tree.jsonl")

    def solve(self, state: GameState, tr: Transcript, item: str = ""):
        if item.lower() not in ("proc_tree.jsonl", "proc", "malware", ""):
            print("Nothing interesting to inspect here.")
            return

        print("[Room Malware] Traversing process tree...")
        try:
            rows = read_jsonl(self.path)
        except FileNotFoundError:
            print("[Warning] proc_tree.jsonl not found.")
            return

        if not rows:
            print("[Warning] Empty or malformed JSONL.")
            return

        by_pid: dict[int, dict] = {}
        children: dict[int, list[int]] = collections.defaultdict(list)

        for r in rows:
            try:
                pid = int(r.get("pid", -1))
                ppid = int(r.get("ppid", -1))
                cmd = str(r.get("cmd", "")).strip()
            except Exception:
                continue
            by_pid[pid] = {"ppid": ppid, "cmd": cmd}
            children[ppid].append(pid)

        roots = [pid for pid, meta in by_pid.items() if meta["ppid"] not in by_pid]

        targets = ("curl", "scp")
        visited: set[int] = set()
        queue: collections.deque[tuple[int, list[int]]] = collections.deque(
            (r, [r]) for r in sorted(roots)
        )

        found_pid, found_path, found_cmd = -1, [], ""
        while queue:
            pid, path = queue.popleft()
            if pid in visited:
                continue
            visited.add(pid)
            meta = by_pid.get(pid, {})
            cmd = meta.get("cmd", "")
            if any(cmd.startswith(t) for t in targets):
                found_pid, found_path, found_cmd = pid, path, cmd
                break
            for child in sorted(children.get(pid, [])):
                if child not in visited:
                    queue.append((child, path + [child]))

        if found_pid == -1:
            print("[Warning] No curl/scp leaf found.")
            return

        token = str(found_pid)
        path_str = "->".join(map(str, found_path))

        tr.write(f"TOKEN[PID]={token}")
        tr.write(f"EVIDENCE[PID].PATH={path_str}")
        tr.write(f"EVIDENCE[PID].CMD={found_cmd}")

        state.tokens["PID"] = token
        print(f"Found suspicious leaf: PID={token}")
        print(f"Path: {path_str}")
        print(f"Command: {found_cmd}")
